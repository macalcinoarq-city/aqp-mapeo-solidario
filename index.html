<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Aqp Mapeo Solidario</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    color: #1f2937;   /* gris oscuro m√°s elegante que negro puro */
    }

    #map { height: 100vh; 
    }

    h3 {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 8px;
    }

    strong {
        font-weight: 500;
        display: block;
        margin-top: 10px;
        margin-bottom: 6px;
    }

    label {
    font-size: 13.5px;
    }

    input[type="checkbox"] {
        margin-right: 6px;
    }

    .form-popup {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      width: 300px;
      display: none;
      z-index: 1000;
    }

    button { margin-top: 5px; }

    .app-header {
  position: absolute;
  top: 12px;
  left: 16px;
  display: flex;
  align-items: center;
  z-index: 2000;
}

.app-logo {
  height: 32px;
  margin-right: 10px;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.6));
}

.app-title {
  font-size: 20px;
  font-weight: 700;
  margin: 0;
  color: white;
  text-shadow: 0 2px 6px rgba(0,0,0,0.6);
}

  </style>
</head>

<body>
  <div class="app-header">
  <img src="logo.png" alt="Logo" class="app-logo">
  <h1 class="app-title">AQP activa</h1>
</div>

<div id="map"></div>

<div class="form-popup" id="formPopup">
  <h3>Reportar afectaci√≥n</h3>
  
  <label>Categor√≠a:</label><br>
  <select id="categoria">
    <option>Cuadrillas de limpieza</option>
    <option>Baches profundos</option>
    <option>Donaci√≥n de agua y v√≠veres</option>
    <option>Maquinaria para escombros</option>
    <option>Otros da√±os</option>
  </select><br><br>

  <label>Descripci√≥n:</label><br>
  <textarea id="descripcion" rows="3"></textarea><br><br>

  <label>Imagen (opcional):</label><br>
  <input type="file" id="imagen" accept="image/*"><br><br>

  <button onclick="guardarReporte()">Guardar</button>
  <button onclick="cerrarFormulario()">Cancelar</button>
</div>

<button onclick="usarUbicacion()" 
style="position:fixed;top:20px;left:20px;z-index:1000;">
üìç Usar mi ubicaci√≥n
</button>
  
<!-- üëá PANEL DE FILTROS AQU√ç -->

<div id="panel" style="
    position: fixed;
    top: 80px;
    left: 20px;
    width: 260px;
    background: white;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    z-index: 1000;
    font-size: 14px;
">
  
  <button id="togglePanel" style="
    position:absolute;
    top:8px;
    right:8px;
    border:none;
    background:#eee;
    border-radius:6px;
    cursor:pointer;
    padding:4px 8px;
    font-size:12px;
">‚úï</button>

<div id="panelContent">


    <h3 style="margin-top:0;">Filtros</h3>

    <hr>

    <strong>Categor√≠as</strong><br>

    <label><input type="checkbox" value="Cuadrillas de limpieza" checked> Cuadrillas</label><br>
    <label><input type="checkbox" value="Baches profundos" checked> Baches</label><br>
    <label><input type="checkbox" value="Donaci√≥n de agua y v√≠veres" checked> Agua</label><br>
    <label><input type="checkbox" value="Maquinaria para escombros" checked> Maquinaria</label><br>
    <label><input type="checkbox" value="Otros da√±os" checked> Otros</label><br>

    <hr>

    <strong>Fecha</strong><br>

    <label>
        <input type="checkbox" id="filtro24h">
        Solo √∫ltimas 24h
    </label><br><br>

    <label>Desde:<br>
        <input type="date" id="fechaDesde" style="width:100%;">
    </label><br><br>

    <label>Hasta:<br>
        <input type="date" id="fechaHasta" style="width:100%;">
    </label>

    <hr>

    <strong>Estad√≠sticas</strong><br>
    Total: <span id="totalReportes">0</span><br><br>

    <div id="conteoCategorias"></div>

</div> <!-- cierre panelContent -->
</div> <!-- cierre panel -->

<script>


  const supabaseUrl = "https://esgprjbtkykdkzhpkjie.supabase.co";
  const supabaseKey = "sb_publishable_Pjl5CaB7eqtkAaBIaVVdXg_qAIXMB4S";
  const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);


  var map = L.map('map').setView([-16.4090, -71.5375], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);


  // üëá AQU√ç VA LA FUNCI√ìN

  function obtenerColor(categoria) {
    switch (categoria) {
      case "Cuadrillas de limpieza":
        return "#2ECC71";
      case "Baches profundos":
        return "#F1C40F";
      case "Donaci√≥n de agua y v√≠veres":
        return "#3498DB";
      case "Maquinaria para escombros":
        return "#8E44AD";
      case "Otros da√±os":
        return "#E74C3C";
      default:
        return "#7F8C8D";
    }
  }

  var marcadorTemporal = null;
  var marcadores = [];


  map.on('click', function(e) {

  // Si ya existe un marcador temporal lo eliminamos
  if (marcadorTemporal) {
    map.removeLayer(marcadorTemporal);
  }

  // Creamos marcador draggable
  const categoriaSeleccionada = document.getElementById('categoria').value;

  marcadorTemporal = L.circleMarker(e.latlng, {
    radius: 10,
    color: obtenerColor(categoriaSeleccionada),
    fillColor: obtenerColor(categoriaSeleccionada),
    fillOpacity: 0.9
  }).addTo(map);

  document.getElementById('formPopup').style.display = 'block';
});

  async function guardarReporte() {
  if (!marcadorTemporal) return;

  const categoria = document.getElementById('categoria').value;
  const descripcion = document.getElementById('descripcion').value;
  const archivo = document.getElementById('imagen').files[0];

  let imagenUrl = null;

  // Si hay imagen, subirla
  if (archivo) {
    const nombreArchivo = `${Date.now()}_${archivo.name}`;

    const { error: uploadError } = await supabaseClient.storage
      .from('imagenes-reportes')
      .upload(nombreArchivo, archivo);

    if (uploadError) {
      alert("Error al subir imagen: " + uploadError.message);
      return;
    }

    const { data: publicUrlData } = supabaseClient.storage
      .from('imagenes-reportes')
      .getPublicUrl(nombreArchivo);

    imagenUrl = publicUrlData.publicUrl;
  }

    const posicionFinal = marcadorTemporal.getLatLng();

    const { error } = await supabaseClient
      .from('reportes')
      .insert([{
        categoria: categoria,
        descripcion: descripcion,
        lat: posicionFinal.lat,
        lng: posicionFinal.lng,
        imagen_url: imagenUrl
      }]);


  if (error) {
    alert("Error al guardar: " + error.message);
  } else {

    let popupContenido = `<b>${categoria}</b><br>${descripcion}`;

    if (imagenUrl) {
      popupContenido += `<br><img src="${imagenUrl}" width="200">`;
    }

    L.marker(marcadorTemporal)
      .addTo(map)
      .bindPopup(popupContenido);

    cerrarFormulario();
  }
}

  function cerrarFormulario() {
    document.getElementById('formPopup').style.display = 'none';
  }

  function usarUbicacion() {
    map.locate({setView: true, maxZoom: 16});
  }

  async function cargarReportes() {
    const { data, error } = await supabaseClient
      .from('reportes')
      .select('*');

    if (data) {
      // üî¢ Actualizar total
        document.getElementById("totalReportes").innerText = data.length;

      // üìä Contar por categor√≠a
        const conteo = {};

        data.forEach(r => {
            if (!conteo[r.categoria]) {
                conteo[r.categoria] = 0;
            }
           conteo[r.categoria]++;
        });

      // Mostrar conteo en el panel
        let htmlConteo = "";
        for (let categoria in conteo) {
            htmlConteo += categoria + ": " + conteo[categoria] + "<br>";
        }

        document.getElementById("conteoCategorias").innerHTML = htmlConteo;

        data.forEach(r => {

        let popupContenido = `<b>${r.categoria}</b><br>${r.descripcion}`;

        if (r.imagen_url) {
          popupContenido += `<br><img src="${r.imagen_url}" width="200">`;
        }

        const marcador = L.circleMarker([r.lat, r.lng], {
          radius: 8,
          color: obtenerColor(r.categoria),
          fillColor: obtenerColor(r.categoria),
          fillOpacity: 0.9
        })
        .addTo(map)
        .bindPopup(popupContenido);

        marcadores.push({
            categoria: r.categoria,
            marker: marcador,
            fecha: r.created_at
        });
        
       
      });

    }
  }

  cargarReportes();
  function aplicarFiltros() {

    const checkboxes = document.querySelectorAll('#filtros input[type="checkbox"]');
    const categoriasActivas = [];
   
    const solo24h = document.getElementById("filtro24h").checked;
    const ahora = new Date();

    const fechaDesdeInput = document.getElementById("fechaDesde").value;
    const fechaHastaInput = document.getElementById("fechaHasta").value;

    const fechaDesde = fechaDesdeInput ? new Date(fechaDesdeInput) : null;
    const fechaHasta = fechaHastaInput ? new Date(fechaHastaInput) : null;


    checkboxes.forEach(cb => {
        if (cb.checked) {
            categoriasActivas.push(cb.value);
        }
    });

    let totalVisible = 0;
    const conteoVisible = {};

    marcadores.forEach(obj => {

        let mostrar = categoriasActivas.includes(obj.categoria);

        if (solo24h && obj.fecha) {
            const fechaReporte = new Date(obj.fecha);
            const diferenciaHoras = (ahora - fechaReporte) / (1000 * 60 * 60);
            if (diferenciaHoras > 24) {
                mostrar = false;
            }
        }
        // üîé Filtro por rango de fechas
        if (obj.fecha) {
            const fechaReporte = new Date(obj.fecha);

            if (fechaDesde && fechaReporte < fechaDesde) {
                mostrar = false;
            }

            if (fechaHasta) {
                const finDelDia = new Date(fechaHasta);
                finDelDia.setHours(23, 59, 59, 999);

                if (fechaReporte > finDelDia) {
                    mostrar = false;
                }
            }
        }


        if (mostrar) {

            map.addLayer(obj.marker);

            totalVisible++;

            if (!conteoVisible[obj.categoria]) {
                conteoVisible[obj.categoria] = 0;
            }

            conteoVisible[obj.categoria]++;

        } else {

            map.removeLayer(obj.marker);

        }
    });

    // üî¢ Actualizar total visible
    document.getElementById("totalReportes").innerText = totalVisible;

    // üìä Actualizar conteo visible
    let htmlConteo = "";
    for (let categoria in conteoVisible) {
        htmlConteo += categoria + ": " + conteoVisible[categoria] + "<br>";
    }

    document.getElementById("conteoCategorias").innerHTML = htmlConteo;
}


// Escuchar cambios en los checkboxes
document.querySelectorAll('#panel input[type="checkbox"]').forEach(cb => {
  cb.addEventListener('change', aplicarFiltros);
});
document.getElementById("fechaDesde").addEventListener("change", aplicarFiltros);
document.getElementById("fechaHasta").addEventListener("change", aplicarFiltros);
document.getElementById("filtro24h").addEventListener("change", aplicarFiltros);
document.getElementById("filtro24h").addEventListener("change", aplicarFiltros);


// ===== Panel colapsable =====

const panel = document.getElementById("panel");
const panelContent = document.getElementById("panelContent");
const toggleBtn = document.getElementById("togglePanel");

const openBtn = document.createElement("button");
openBtn.innerText = "‚ò∞ Filtros";
openBtn.style.position = "fixed";
openBtn.style.top = "80px";
openBtn.style.left = "20px";
openBtn.style.background = "white";
openBtn.style.border = "none";
openBtn.style.borderRadius = "12px";
openBtn.style.boxShadow = "0 6px 18px rgba(0,0,0,0.15)";
openBtn.style.padding = "8px 12px";
openBtn.style.cursor = "pointer";
openBtn.style.zIndex = "999";
openBtn.style.display = "none";

document.body.appendChild(openBtn);

toggleBtn.addEventListener("click", () => {
    panel.style.display = "none";
    openBtn.style.display = "block";
});

openBtn.addEventListener("click", () => {
    panel.style.display = "block";
    openBtn.style.display = "none";
});

</script>


</body>
</html>
