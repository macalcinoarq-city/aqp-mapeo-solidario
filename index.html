<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Aqp Mapeo Solidario</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    color: #1f2937;   /* gris oscuro m√°s elegante que negro puro */
    }

    #map { height: 100vh; 
    }

    h3 {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 8px;
    }

    strong {
        font-weight: 500;
        display: block;
        margin-top: 10px;
        margin-bottom: 6px;
    }

    label {
    font-size: 13.5px;
    }

    input[type="checkbox"] {
        margin-right: 6px;
    }

    .form-popup {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      width: 300px;
      display: none;
      z-index: 1000;
    }

    button { margin-top: 5px; }

    .app-header {
  position: absolute;
  left: 16px;
  bottom: calc(12px + env(safe-area-inset-bottom));
  display: flex;
  align-items: center;
  padding: 10px 14px;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 10px;
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
  z-index: 2000;
}

.app-logo {
  height: 34px;
  margin-right: 10px;
}

.app-title {
  font-size: 22px;
  font-weight: 400;
  margin: 0;
  color: #ffffff;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  text-shadow:
    0 0 4px #FFB300,
    0 0 8px #FFB300,
    0 0 16px rgba(255,179,0,0.8),
    0 2px 4px rgba(0,0,0,0.6);
  
}
#addMarkerBtn {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  border: none;
  background: #ffb300; /* amarillo-naranja */
  color: white;
  font-size: 28px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 6px 18px rgba(0,0,0,0.3);
  z-index: 2000;
}

#addMarkerBtn:active {
  transform: scale(0.95);
}
#togglePanel {
  position: fixed;
  top: 16px;
  right: 16px;
  border: none;
  background: #ffb300; /* amarillo */
  color: white;
  border-radius: 20px;
  cursor: pointer;
  padding: 8px 16px;
  font-size: 13px;
  font-weight: 600;
  letter-spacing: 1px;
  z-index: 2000;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  transition: all 0.2s ease;
}

#togglePanel:active {
  transform: scale(0.95);
}

#togglePanel:hover {
  background: #e65100; /* naranja m√°s intenso */
}
    @media (max-width: 600px) {

  #panel {
    width: 65vw !important;
    max-width: 230px;
    padding: 6px !important;
    font-size: 11px;
    top: 65px !important;
    right: 8px !important;
    border-radius: 6px;
  }

  #addMarkerBtn {
    width: 50px;
    height: 50px;
    font-size: 24px;
    bottom: 80px;
    right: 16px;
  }

  #panel h3 {
    font-size: 12px;
    margin-bottom: 4px;
  }
   
  #panel strong {
    font-size: 10px;
  }

  #panel label {
    font-size: 10px;
  }

  #panel input,
  #panel select {
    font-size: 10px;
  }

  #panel hr {
    margin: 4px 0;
  }
  
  #toast {
    position: fixed;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%);
    background: #1f2937;
    color: white;
    padding: 12px 18px;
    border-radius: 8px;
    font-size: 14px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 3000;
  }

  #toast.show {
    opacity: 1;

}

  </style>
</head>

<body>
  <div class="app-header">
  <img src="logo.png" alt="Logo" class="app-logo">
  <h1 class="app-title">AQP activa</h1>
</div>

<div id="map"></div>
  <button id="addMarkerBtn">+</button>

  <div id="toast"></div>

<div class="form-popup" id="formPopup">
  <h3>Reportar afectaci√≥n</h3>
  
  <label>Categor√≠a:</label><br>
  <select id="categoria">
    <option>Cuadrillas de limpieza</option>
    <option>Baches profundos</option>
    <option>Donaci√≥n de agua y v√≠veres</option>
    <option>Maquinaria para escombros</option>
    <option>Otros da√±os</option>
  </select><br><br>

  <label>Descripci√≥n:</label><br>
  <textarea id="descripcion" rows="3"></textarea><br><br>

  <label>Imagen (opcional):</label><br>
  <input type="file" id="imagen" accept="image/*"><br><br>

  <button onclick="guardarReporte()">Guardar</button>
  <button onclick="cerrarFormulario()">Cancelar</button>
</div>

<button onclick="usarUbicacion()" 
style="position:fixed;top:20px;left:20px;z-index:1000;">
üìç Usar mi ubicaci√≥n
</button>
  
<!-- üëá PANEL DE FILTROS AQU√ç -->

<button id="togglePanel">
  CAPAS
</button>
  
  <div id="panel" style="
  position: absolute;
  top: 80px;
  right: 16px;
  background: white;
  padding: 12px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  z-index: 1500;
  display: none;
">
  
    <h3 style="margin-top:0;">Filtros</h3>

    <hr>

    <strong>Categor√≠as</strong><br>

    <label><input type="checkbox" value="Cuadrillas de limpieza" checked> Cuadrillas</label><br>
    <label><input type="checkbox" value="Baches profundos" checked> Baches</label><br>
    <label><input type="checkbox" value="Donaci√≥n de agua y v√≠veres" checked> Agua</label><br>
    <label><input type="checkbox" value="Maquinaria para escombros" checked> Maquinaria</label><br>
    <label><input type="checkbox" value="Otros da√±os" checked> Otros</label><br>

    <hr>

    <strong>Fecha</strong><br>

    <label>
        <input type="checkbox" id="filtro24h">
        Solo √∫ltimas 24h
    </label><br><br>

    <label>Desde:<br>
        <input type="date" id="fechaDesde" style="width:100%;">
    </label><br><br>

    <label>Hasta:<br>
        <input type="date" id="fechaHasta" style="width:100%;">
    </label>

    <hr>

    <strong>Estad√≠sticas</strong><br>
    Total: <span id="totalReportes">0</span><br><br>

    <div id="conteoCategorias"></div>

</div> <!-- cierre panel -->

<script>


  const supabaseUrl = "https://esgprjbtkykdkzhpkjie.supabase.co";
  const supabaseKey = "sb_publishable_Pjl5CaB7eqtkAaBIaVVdXg_qAIXMB4S";
  const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);


  var map = L.map('map').setView([-16.4090, -71.5375], 13);

// üó∫Ô∏è Mapa est√°ndar
const normal = L.tileLayer(
  'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  { attribution: '&copy; OpenStreetMap' }
);

// üõ∞Ô∏è Satelital Esri
const satelite = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  { attribution: 'Tiles ¬© Esri' }
);

// Activar por defecto
satelite.addTo(map);

// Selector profesional
L.control.layers(
  {
    "üó∫Ô∏è Mapa": normal,
    "üõ∞Ô∏è Satelital": satelite
  },
  null,
  { position: "topleft" }
).addTo(map);

  let marcadorTemporal = null;


  // üëá AQU√ç VA LA FUNCI√ìN

  function mostrarToast(mensaje) {
  const toast = document.getElementById("toast");
  toast.innerText = mensaje;
  toast.classList.add("show");

  setTimeout(() => {
    toast.classList.remove("show");
  }, 2500);
}
  function obtenerColor(categoria) {
    switch (categoria) {
      case "Cuadrillas de limpieza":
        return "#2ECC71";
      case "Baches profundos":
        return "#F1C40F";
      case "Donaci√≥n de agua y v√≠veres":
        return "#3498DB";
      case "Maquinaria para escombros":
        return "#8E44AD";
      case "Otros da√±os":
        return "#E74C3C";
      default:
        return "#7F8C8D";
    }
  }
  function obtenerColorEstado(estado) {
  switch (estado) {
    case "no_atendido":
      return "#e53935"; // rojo
    case "en_proceso":
      return "#fbc02d"; // amarillo
    case "atendido":
      return "#43a047"; // verde
    default:
      return "#757575"; // gris fallback
  }
}
  function obtenerEmojiCategoria(categoria) {
  switch (categoria) {
    case "Cuadrillas de limpieza":
      return "üßπ";
    case "Baches profundos":
      return "üï≥Ô∏è";
    case "Donaci√≥n de agua y v√≠veres":
      return "üíß";
    case "Maquinaria para escombros":
      return "üöú";
    case "Otros da√±os":
      return "‚ö†Ô∏è";
    default:
      return "üìç";
  }
}

  
  var marcadores = [];

 
  async function guardarReporte() {
  if (!marcadorTemporal) return;

  const categoria = document.getElementById('categoria').value;
  const descripcion = document.getElementById('descripcion').value;
  const archivo = document.getElementById('imagen').files[0];

  let imagenUrl = null;

  // Si hay imagen, subirla
  if (archivo) {
    const nombreArchivo = `${Date.now()}_${archivo.name}`;

    const { error: uploadError } = await supabaseClient.storage
      .from('imagenes-reportes')
      .upload(nombreArchivo, archivo);

    if (uploadError) {
      alert("Error al subir imagen: " + uploadError.message);
      return;
    }

    const { data: publicUrlData } = supabaseClient.storage
      .from('imagenes-reportes')
      .getPublicUrl(nombreArchivo);

    imagenUrl = publicUrlData.publicUrl;
  }

    const posicionFinal = marcadorTemporal.getLatLng();

    const { error } = await supabaseClient
      .from('reportes')
      .insert([{
        categoria: categoria,
        descripcion: descripcion,
        lat: posicionFinal.lat,
        lng: posicionFinal.lng,
        imagen_url: imagenUrl
      }]);


  if (error) {
    alert("Error al guardar: " + error.message);
  } else {

    let popupContenido = `<b>${categoria}</b><br>${descripcion}`;

    if (imagenUrl) {
        popupContenido += `<br><img src="${imagenUrl}" width="200">`;
    }

    // Crear marcador definitivo
    // Crear marcador definitivo
const marcadorDefinitivo = L.circleMarker([posicionFinal.lat, posicionFinal.lng], {
  radius: 8,
  color: obtenerColor(categoria),
  fillColor: obtenerColor(categoria),
  fillOpacity: 0.9
})
.addTo(map)
.bindPopup(popupContenido);

// üî• AGREGARLO AL ARRAY GLOBAL
marcadores.push({
  categoria: categoria,
  marker: marcadorDefinitivo,
  fecha: new Date() // importante para filtro por fecha
});

    // Eliminar marcador temporal
    if (marcadorTemporal) {
        map.removeLayer(marcadorTemporal);
        marcadorTemporal = null;
    }

    // Cerrar formulario
    cerrarFormulario();

    // Mostrar confirmaci√≥n elegante
    mostrarToast("Reporte enviado correctamente ‚úî");
}
}
  function cerrarFormulario() {
    document.getElementById('formPopup').style.display = 'none';
  }

  function usarUbicacion() {
    map.locate({setView: true, maxZoom: 16});
  }

  async function cargarReportes() {
    const { data, error } = await supabaseClient
      .from('reportes')
      .select('*');

    if (data) {
      // üî¢ Actualizar total
        document.getElementById("totalReportes").innerText = data.length;

      // üìä Contar por categor√≠a
        const conteo = {};

        data.forEach(r => {
            if (!conteo[r.categoria]) {
                conteo[r.categoria] = 0;
            }
           conteo[r.categoria]++;
        });

      // Mostrar conteo en el panel
        let htmlConteo = "";
        for (let categoria in conteo) {
            htmlConteo += categoria + ": " + conteo[categoria] + "<br>";
        }

        document.getElementById("conteoCategorias").innerHTML = htmlConteo;

        data.forEach(r => {

        let popupContenido = `<b>${r.categoria}</b><br>${r.descripcion}`;

        if (r.imagen_url) {
          popupContenido += `<br><img src="${r.imagen_url}" width="200">`;
        }

        const colorEstado = obtenerColorEstado(r.estado);
        const emoji = obtenerEmojiCategoria(r.categoria);

const marcador = L.marker([r.lat, r.lng], {
  icon: L.divIcon({
    className: "",
    html: `
      <div style="
        background:${colorEstado};
        width:28px;
        height:28px;
        border-radius:50%;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:14px;
        box-shadow:0 2px 6px rgba(0,0,0,0.4);
      ">
        ${emoji}
      </div>
    `,
    iconSize: [28, 28],
    iconAnchor: [14, 14]
  })
})
.addTo(map)
.bindPopup(popupContenido);
          
        marcadores.push({
          categoria: r.categoria,
          estado: r.estado,
          marker: marcador,
          fecha: r.created_at ? new Date(r.created_at) : null
        });
        
       
      });

    }
  }

  cargarReportes();
  function aplicarFiltros() {

    const checkboxes = document.querySelectorAll('#panel input[type="checkbox"]');
    const categoriasActivas = [];
   
    const solo24h = document.getElementById("filtro24h").checked;
    const ahora = new Date();

    const fechaDesdeInput = document.getElementById("fechaDesde").value;
    const fechaHastaInput = document.getElementById("fechaHasta").value;

    const fechaDesde = fechaDesdeInput ? new Date(fechaDesdeInput) : null;
    const fechaHasta = fechaHastaInput ? new Date(fechaHastaInput) : null;


    checkboxes.forEach(cb => {
        if (cb.checked) {
            categoriasActivas.push(cb.value);
        }
    });

    let totalVisible = 0;
    const conteoVisible = {};

    marcadores.forEach(obj => {

        let mostrar = categoriasActivas.includes(obj.categoria);

        if (solo24h && obj.fecha instanceof Date) {
          const fechaReporte = obj.fecha;
            const diferenciaHoras = (ahora - fechaReporte) / (1000 * 60 * 60);
            if (diferenciaHoras > 24) {
                mostrar = false;
            }
        }
        // üîé Filtro por rango de fechas
        if (obj.fecha) {
            const fechaReporte = new Date(obj.fecha);

            if (fechaDesde && fechaReporte.getTime() < fechaDesde.getTime()) {
                mostrar = false;
            }

            if (fechaHasta) {
              const finDelDia = new Date(fechaHasta);
              finDelDia.setHours(23, 59, 59, 999);

              if (fechaReporte.getTime() > finDelDia.getTime()) {
              mostrar = false;
              }
            }
          
        }


        if (mostrar) {

            map.addLayer(obj.marker);

            totalVisible++;

            if (!conteoVisible[obj.categoria]) {
                conteoVisible[obj.categoria] = 0;
            }

            conteoVisible[obj.categoria]++;

        } else {

            map.removeLayer(obj.marker);

        }
    });

    // üî¢ Actualizar total visible
    document.getElementById("totalReportes").innerText = totalVisible;

    // üìä Actualizar conteo visible
    let htmlConteo = "";
    for (let categoria in conteoVisible) {
        htmlConteo += categoria + ": " + conteoVisible[categoria] + "<br>";
    }

    document.getElementById("conteoCategorias").innerHTML = htmlConteo;
}


// Escuchar cambios en los checkboxes
document.querySelectorAll('#panel input[type="checkbox"]').forEach(cb => {
  cb.addEventListener('change', aplicarFiltros);
});
document.getElementById("fechaDesde").addEventListener("change", aplicarFiltros);
document.getElementById("fechaHasta").addEventListener("change", aplicarFiltros);
document.getElementById("filtro24h").addEventListener("change", aplicarFiltros);
document.getElementById("filtro24h").addEventListener("change", aplicarFiltros);


// ===== Panel colapsable =====

const panel = document.getElementById("panel");
const toggleBtn = document.getElementById("togglePanel");

toggleBtn.addEventListener("click", () => {
  if (panel.style.display === "none" || panel.style.display === "") {
    panel.style.display = "block";
  } else {
    panel.style.display = "none";
  }
});

// ===== BOT√ìN AGREGAR MARCADOR =====

// Ya estaba declarado arriba, NO lo redeclaramos
// const addMarkerBtn = document.getElementById("addMarkerBtn");

const addMarkerBtn = document.getElementById("addMarkerBtn");
const formPopup = document.getElementById("formPopup");

let selectingLocation = false;
let selectedLat = null;
let selectedLng = null;

addMarkerBtn.addEventListener("click", () => {
  selectingLocation = true;
  addMarkerBtn.style.background = "#e65100";
  alert("Toca el mapa para ubicar el reporte");
});

  map.on("click", function(e) {

  if (!selectingLocation) return;

  // Si ya existe un marcador temporal lo eliminamos
  if (marcadorTemporal) {
    map.removeLayer(marcadorTemporal);
  }

  const categoriaSeleccionada = document.getElementById("categoria").value;

  marcadorTemporal = L.circleMarker(e.latlng, {
    radius: 10,
    color: obtenerColor(categoriaSeleccionada),
    fillColor: obtenerColor(categoriaSeleccionada),
    fillOpacity: 0.9
  }).addTo(map);

  document.getElementById("formPopup").style.display = "block";

  selectingLocation = false;
  addMarkerBtn.style.background = "#ffb300";

});

  
</script>


</body>
</html>
